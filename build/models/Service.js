"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_descriptor6,_descriptor7,_descriptor8,_descriptor9,_descriptor10,_descriptor11,_descriptor12,_descriptor13,_descriptor14,_descriptor15,_descriptor16,_descriptor17,_descriptor18,_descriptor19,_descriptor20,_descriptor21,_descriptor22,_descriptor23,_descriptor24,_descriptor25,_descriptor26,_descriptor27,_descriptor28,_descriptor29,_descriptor30,_descriptor31,_descriptor32,_descriptor33,_descriptor34,_descriptor35,_descriptor36,_descriptor37,_descriptor38,_mobx=require("mobx"),_electron=require("electron"),_remote=require("@electron/remote"),_normalizeUrl=_interopRequireDefault(require("normalize-url")),_path=require("path"),_todos=require("../features/todos"),_urlHelpers=require("../helpers/url-helpers"),_UserAgent=_interopRequireDefault(require("./UserAgent")),_config=require("../config"),_jsUtils=require("../jsUtils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _initializerDefineProperty(e,i,r,t){r&&Object.defineProperty(e,i,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(t):void 0})}function _applyDecoratedDescriptor(e,i,r,t,s){var o={};return Object.keys(t).forEach((function(e){o[e]=t[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=r.slice().reverse().reduce((function(r,t){return t(e,i,r)||r}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,i,o),o=null),o}function _initializerWarningHelper(e,i){throw new Error("Decorating class property failed. Please ensure that proposal-class-properties is enabled and runs after the decorators transform.")}const debug=require("debug")("Ferdi:Service");let Service=(_descriptor=_applyDecoratedDescriptor((_class=class{constructor(e,i){if(this.id="",this.recipe=null,this._webview=null,this.timer=null,this.events={},_initializerDefineProperty(this,"isAttached",_descriptor,this),_initializerDefineProperty(this,"isActive",_descriptor2,this),_initializerDefineProperty(this,"name",_descriptor3,this),_initializerDefineProperty(this,"unreadDirectMessageCount",_descriptor4,this),_initializerDefineProperty(this,"unreadIndirectMessageCount",_descriptor5,this),_initializerDefineProperty(this,"dialogTitle",_descriptor6,this),_initializerDefineProperty(this,"order",_descriptor7,this),_initializerDefineProperty(this,"isEnabled",_descriptor8,this),_initializerDefineProperty(this,"isMuted",_descriptor9,this),_initializerDefineProperty(this,"team",_descriptor10,this),_initializerDefineProperty(this,"customUrl",_descriptor11,this),_initializerDefineProperty(this,"isNotificationEnabled",_descriptor12,this),_initializerDefineProperty(this,"isBadgeEnabled",_descriptor13,this),_initializerDefineProperty(this,"isIndirectMessageBadgeEnabled",_descriptor14,this),_initializerDefineProperty(this,"iconUrl",_descriptor15,this),_initializerDefineProperty(this,"hasCustomUploadedIcon",_descriptor16,this),_initializerDefineProperty(this,"hasCrashed",_descriptor17,this),_initializerDefineProperty(this,"isDarkModeEnabled",_descriptor18,this),_initializerDefineProperty(this,"darkReaderSettings",_descriptor19,this),_initializerDefineProperty(this,"spellcheckerLanguage",_descriptor20,this),_initializerDefineProperty(this,"isFirstLoad",_descriptor21,this),_initializerDefineProperty(this,"isLoading",_descriptor22,this),_initializerDefineProperty(this,"isError",_descriptor23,this),_initializerDefineProperty(this,"errorMessage",_descriptor24,this),_initializerDefineProperty(this,"isUsingCustomUrl",_descriptor25,this),_initializerDefineProperty(this,"isServiceAccessRestricted",_descriptor26,this),_initializerDefineProperty(this,"restrictionType",_descriptor27,this),_initializerDefineProperty(this,"isHibernationEnabled",_descriptor28,this),_initializerDefineProperty(this,"isWakeUpEnabled",_descriptor29,this),_initializerDefineProperty(this,"isHibernationRequested",_descriptor30,this),_initializerDefineProperty(this,"onlyShowFavoritesInUnreadCount",_descriptor31,this),_initializerDefineProperty(this,"lastUsed",_descriptor32,this),_initializerDefineProperty(this,"lastHibernated",_descriptor33,this),_initializerDefineProperty(this,"lastPoll",_descriptor34,this),_initializerDefineProperty(this,"lastPollAnswer",_descriptor35,this),_initializerDefineProperty(this,"lostRecipeConnection",_descriptor36,this),_initializerDefineProperty(this,"lostRecipeReloadAttempt",_descriptor37,this),_initializerDefineProperty(this,"userAgentModel",_descriptor38,this),!e)throw new Error("Service config not valid");if(!i)throw new Error("Service recipe not valid");this.recipe=i,this.userAgentModel=new _UserAgent.default(i.overrideUserAgent),this.id=(0,_jsUtils.ifUndefinedString)(e.id,this.id),this.name=(0,_jsUtils.ifUndefinedString)(e.name,this.name),this.team=(0,_jsUtils.ifUndefinedString)(e.team,this.team),this.customUrl=(0,_jsUtils.ifUndefinedString)(e.customUrl,this.customUrl),this.iconUrl=(0,_jsUtils.ifUndefinedString)(e.iconUrl,this.iconUrl),this.order=(0,_jsUtils.ifUndefinedNumber)(e.order,this.order),this.isEnabled=(0,_jsUtils.ifUndefinedBoolean)(e.isEnabled,this.isEnabled),this.isNotificationEnabled=(0,_jsUtils.ifUndefinedBoolean)(e.isNotificationEnabled,this.isNotificationEnabled),this.isBadgeEnabled=(0,_jsUtils.ifUndefinedBoolean)(e.isBadgeEnabled,this.isBadgeEnabled),this.isIndirectMessageBadgeEnabled=(0,_jsUtils.ifUndefinedBoolean)(e.isIndirectMessageBadgeEnabled,this.isIndirectMessageBadgeEnabled),this.isMuted=(0,_jsUtils.ifUndefinedBoolean)(e.isMuted,this.isMuted),this.isDarkModeEnabled=(0,_jsUtils.ifUndefinedBoolean)(e.isDarkModeEnabled,this.isDarkModeEnabled),this.darkReaderSettings=(0,_jsUtils.ifUndefinedString)(e.darkReaderSettings,this.darkReaderSettings),this.hasCustomUploadedIcon=(0,_jsUtils.ifUndefinedBoolean)(e.hasCustomIcon,this.hasCustomUploadedIcon),this.onlyShowFavoritesInUnreadCount=(0,_jsUtils.ifUndefinedBoolean)(e.onlyShowFavoritesInUnreadCount,this.onlyShowFavoritesInUnreadCount),this.proxy=(0,_jsUtils.ifUndefinedString)(e.proxy,this.proxy),this.spellcheckerLanguage=(0,_jsUtils.ifUndefinedString)(e.spellcheckerLanguage,this.spellcheckerLanguage),this.userAgentPref=(0,_jsUtils.ifUndefinedString)(e.userAgentPref,this.userAgentPref),this.isHibernationEnabled=(0,_jsUtils.ifUndefinedBoolean)(e.isHibernationEnabled,this.isHibernationEnabled),this.isWakeUpEnabled=(0,_jsUtils.ifUndefinedBoolean)(e.isWakeUpEnabled,this.isWakeUpEnabled);const{hibernateOnStartup:r}=window.ferdi.stores.settings.app,t=window.localStorage.service&&JSON.parse(window.localStorage.service).activeService===this.id;r&&!t&&(this.isHibernationRequested=!0),(0,_mobx.autorun)((()=>{this.isEnabled||(this.webview=null,this.isAttached=!1,this.unreadDirectMessageCount=0,this.unreadIndirectMessageCount=0),this.recipe.hasCustomUrl&&this.customUrl&&(this.isUsingCustomUrl=!0)}))}get shareWithWebview(){return{id:this.id,spellcheckerLanguage:this.spellcheckerLanguage,isDarkModeEnabled:this.isDarkModeEnabled,darkReaderSettings:this.darkReaderSettings,team:this.team,url:this.url,hasCustomIcon:this.hasCustomIcon,onlyShowFavoritesInUnreadCount:this.onlyShowFavoritesInUnreadCount}}get isTodosService(){return this.recipe.id===_todos.todosStore.todoRecipeId}get canHibernate(){return this.isHibernationEnabled}get isHibernating(){return this.canHibernate&&this.isHibernationRequested}get webview(){return this.isTodosService?_todos.todosStore.webview:this._webview}set webview(e){this._webview=e}get url(){if(this.recipe.hasCustomUrl&&this.customUrl){let e;try{e=(0,_normalizeUrl.default)(this.customUrl,{stripAuthentication:!1,stripWWW:!1,removeTrailingSlash:!1})}catch{console.error(`Service (${this.recipe.name}): '${this.customUrl}' is not a valid Url.`)}return"function"==typeof this.recipe.buildUrl&&(e=this.recipe.buildUrl(e)),e}return this.recipe.hasTeamId&&this.team?this.recipe.serviceURL.replace("{teamId}",this.team):this.recipe.serviceURL}get icon(){return this.iconUrl?this.iconUrl:(0,_path.join)(this.recipe.path,"icon.svg")}get hasCustomIcon(){return Boolean(this.iconUrl)}get userAgent(){return this.userAgentModel.userAgent}get userAgentPref(){return this.userAgentModel.userAgentPref}set userAgentPref(e){this.userAgentModel.userAgentPref=e}get defaultUserAgent(){return this.userAgentModel.defaultUserAgent}get partition(){return this.recipe.partition||`persist:service-${this.id}`}initializeWebViewEvents({handleIPCMessage:e,openWindow:i,stores:r}){const t=_remote.webContents.fromId(this.webview.getWebContentsId());if(this.userAgentModel.setWebviewReference(this.webview),"function"==typeof this.recipe.modifyRequestHeaders){const e=this.recipe.modifyRequestHeaders();debug(this.name,"modifiedRequestHeaders",e),_electron.ipcRenderer.send("modifyRequestHeaders",{modifiedRequestHeaders:e,serviceId:this.id})}else debug(this.name,"modifyRequestHeaders is not defined in the recipe");if("function"==typeof this.recipe.knownCertificateHosts){const e=this.recipe.knownCertificateHosts();debug(this.name,"knownCertificateHosts",e),_electron.ipcRenderer.send("knownCertificateHosts",{knownHosts:e,serviceId:this.id})}else debug(this.name,"knownCertificateHosts is not defined in the recipe");this.webview.addEventListener("ipc-message",(async i=>{"inject-js-unsafe"===i.channel?await Promise.all(i.args.map((e=>this.webview.executeJavaScript(`"use strict"; (() => { ${e} })();`)))):e({serviceId:this.id,channel:i.channel,args:i.args})})),this.webview.addEventListener("new-window",((e,r,t,s)=>{debug("new-window",e,r,t,s),(0,_urlHelpers.isValidExternalURL)(e.url)&&("foreground-tab"===e.disposition||"background-tab"===e.disposition?i({event:e,url:r,frameName:t,options:s}):_electron.ipcRenderer.send("open-browser-window",{url:e.url,serviceId:this.id}))})),this.webview.addEventListener("did-start-loading",(e=>{debug("Did start load",this.name,e),this.hasCrashed=!1,this.isLoading=!0,this.isError=!1}));const s=()=>{this.isLoading=!1,this.isError||(this.isFirstLoad=!1)};this.webview.addEventListener("did-frame-finish-load",s.bind(this)),this.webview.addEventListener("did-navigate",s.bind(this)),this.webview.addEventListener("did-fail-load",(e=>{debug("Service failed to load",this.name,e),e.isMainFrame&&-21!==e.errorCode&&-3!==e.errorCode&&(this.isError=!0,this.errorMessage=e.errorDescription,this.isLoading=!1)})),this.webview.addEventListener("crashed",(()=>{debug("Service crashed",this.name),this.hasCrashed=!0})),this.webview.addEventListener("found-in-page",(({result:e})=>{debug("Found in page",e),this.webview.send("found-in-page",e)})),t.on("login",((e,i,s,o)=>{if(debug("browser login event",s),e.preventDefault(),s.isProxy&&"basic"===s.scheme){debug("Sending service echo ping"),t.send("get-service-id"),debug("Received service id",this.id);const e=r.settings.proxy[this.id];e?(debug("Sending proxy auth callback for service",this.id),o(e.user,e.password)):debug("No proxy auth config found for",this.id)}}))}initializeWebViewListener(){if(this.webview&&this.recipe.events)for(const e of Object.keys(this.recipe.events)){const i=this.recipe[this.recipe.events[e]];"function"==typeof i&&this.webview.addEventListener(e,i)}}resetMessageCount(){this.unreadDirectMessageCount=0,this.unreadIndirectMessageCount=0}}).prototype,"isAttached",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"isActive",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"name",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"unreadDirectMessageCount",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor5=_applyDecoratedDescriptor(_class.prototype,"unreadIndirectMessageCount",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor6=_applyDecoratedDescriptor(_class.prototype,"dialogTitle",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor7=_applyDecoratedDescriptor(_class.prototype,"order",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _config.DEFAULT_SERVICE_ORDER}}),_descriptor8=_applyDecoratedDescriptor(_class.prototype,"isEnabled",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor9=_applyDecoratedDescriptor(_class.prototype,"isMuted",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor10=_applyDecoratedDescriptor(_class.prototype,"team",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor11=_applyDecoratedDescriptor(_class.prototype,"customUrl",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor12=_applyDecoratedDescriptor(_class.prototype,"isNotificationEnabled",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor13=_applyDecoratedDescriptor(_class.prototype,"isBadgeEnabled",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor14=_applyDecoratedDescriptor(_class.prototype,"isIndirectMessageBadgeEnabled",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor15=_applyDecoratedDescriptor(_class.prototype,"iconUrl",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor16=_applyDecoratedDescriptor(_class.prototype,"hasCustomUploadedIcon",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor17=_applyDecoratedDescriptor(_class.prototype,"hasCrashed",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor18=_applyDecoratedDescriptor(_class.prototype,"isDarkModeEnabled",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor19=_applyDecoratedDescriptor(_class.prototype,"darkReaderSettings",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{brightness:100,contrast:90,sepia:10}}}),_descriptor20=_applyDecoratedDescriptor(_class.prototype,"spellcheckerLanguage",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor21=_applyDecoratedDescriptor(_class.prototype,"isFirstLoad",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor22=_applyDecoratedDescriptor(_class.prototype,"isLoading",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor23=_applyDecoratedDescriptor(_class.prototype,"isError",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor24=_applyDecoratedDescriptor(_class.prototype,"errorMessage",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),_descriptor25=_applyDecoratedDescriptor(_class.prototype,"isUsingCustomUrl",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor26=_applyDecoratedDescriptor(_class.prototype,"isServiceAccessRestricted",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor27=_applyDecoratedDescriptor(_class.prototype,"restrictionType",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor28=_applyDecoratedDescriptor(_class.prototype,"isHibernationEnabled",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor29=_applyDecoratedDescriptor(_class.prototype,"isWakeUpEnabled",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_descriptor30=_applyDecoratedDescriptor(_class.prototype,"isHibernationRequested",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor31=_applyDecoratedDescriptor(_class.prototype,"onlyShowFavoritesInUnreadCount",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor32=_applyDecoratedDescriptor(_class.prototype,"lastUsed",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Date.now()}}),_descriptor33=_applyDecoratedDescriptor(_class.prototype,"lastHibernated",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor34=_applyDecoratedDescriptor(_class.prototype,"lastPoll",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Date.now()}}),_descriptor35=_applyDecoratedDescriptor(_class.prototype,"lastPollAnswer",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Date.now()}}),_descriptor36=_applyDecoratedDescriptor(_class.prototype,"lostRecipeConnection",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor37=_applyDecoratedDescriptor(_class.prototype,"lostRecipeReloadAttempt",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_descriptor38=_applyDecoratedDescriptor(_class.prototype,"userAgentModel",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class.prototype,"shareWithWebview",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"shareWithWebview"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isTodosService",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isTodosService"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"canHibernate",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"canHibernate"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isHibernating",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isHibernating"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"url",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"url"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"icon",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"icon"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"hasCustomIcon",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"hasCustomIcon"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"userAgent",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"userAgent"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"userAgentPref",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"userAgentPref"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"defaultUserAgent",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"defaultUserAgent"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"partition",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"partition"),_class.prototype),_class);exports.default=Service;