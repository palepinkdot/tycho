"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _dec,_class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_mobx=require("mobx"),_userAgentHelpers=_interopRequireDefault(require("../helpers/userAgent-helpers"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _initializerDefineProperty(e,t,r,i){r&&Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(i):void 0})}function _applyDecoratedDescriptor(e,t,r,i,s){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=r.slice().reverse().reduce((function(r,i){return i(e,t,r)||r}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}function _initializerWarningHelper(e,t){throw new Error("Decorating class property failed. Please ensure that proposal-class-properties is enabled and runs after the decorators transform.")}const debug=require("debug")("Ferdi:UserAgent");let UserAgent=(_dec=_mobx.observable.ref,_descriptor=_applyDecoratedDescriptor((_class=class{constructor(e=null){this._willNavigateListener=null,this._didNavigateListener=null,_initializerDefineProperty(this,"webview",_descriptor,this),_initializerDefineProperty(this,"chromelessUserAgent",_descriptor2,this),_initializerDefineProperty(this,"userAgentPref",_descriptor3,this),_initializerDefineProperty(this,"getUserAgent",_descriptor4,this),"function"==typeof e&&(this.getUserAgent=e),(0,_mobx.observe)(this,"webview",(e=>{const{oldValue:t,newValue:r}=e;null!==t&&this._removeWebviewEvents(t),null!==r&&this._addWebviewEvents(r)}))}get defaultUserAgent(){if("function"==typeof this.getUserAgent)return this.getUserAgent();const e=window.ferdi.stores.settings.all.app.userAgentPref;if("string"==typeof e){const t=e.trim();if(""!==t)return t}return(0,_userAgentHelpers.default)()}get serviceUserAgentPref(){if("string"==typeof this.userAgentPref){const e=this.userAgentPref.trim();if(""!==e)return e}return null}get userAgentWithoutChromeVersion(){return this.defaultUserAgent.replace(/Chrome\/[\d.]+/,"Chrome")}get userAgent(){return this.serviceUserAgentPref||(this.chromelessUserAgent?this.userAgentWithoutChromeVersion:this.defaultUserAgent)}setWebviewReference(e){this.webview=e}_handleNavigate(e,t=!1){e.startsWith("https://accounts.google.com")?this.chromelessUserAgent||(debug("Setting user agent to chromeless for url",e),this.chromelessUserAgent=!0,this.webview.userAgent=this.userAgent,t&&this.webview.loadURL(e)):this.chromelessUserAgent&&(debug("Setting user agent to contain chrome for url",e),this.chromelessUserAgent=!1,this.webview.userAgent=this.userAgent)}_addWebviewEvents(e){debug("Adding event handlers"),this._willNavigateListener=e=>this._handleNavigate(e.url,!0),e.addEventListener("will-navigate",this._willNavigateListener),this._didNavigateListener=e=>this._handleNavigate(e.url),e.addEventListener("did-navigate",this._didNavigateListener)}_removeWebviewEvents(e){debug("Removing event handlers"),e.removeEventListener("will-navigate",this._willNavigateListener),e.removeEventListener("did-navigate",this._didNavigateListener)}}).prototype,"webview",[_dec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"chromelessUserAgent",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"userAgentPref",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"getUserAgent",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class.prototype,"defaultUserAgent",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"defaultUserAgent"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"serviceUserAgentPref",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"serviceUserAgentPref"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"userAgentWithoutChromeVersion",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"userAgentWithoutChromeVersion"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"userAgent",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"userAgent"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"setWebviewReference",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"setWebviewReference"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"_handleNavigate",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"_handleNavigate"),_class.prototype),_class);exports.default=UserAgent;