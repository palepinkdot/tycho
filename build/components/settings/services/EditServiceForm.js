"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _react=require("react"),_propTypes=_interopRequireDefault(require("prop-types")),_mobxReact=require("mobx-react"),_reactRouter=require("react-router"),_reactIntl=require("react-intl"),_normalizeUrl=_interopRequireDefault(require("normalize-url")),_js=require("@mdi/js"),_Form=_interopRequireDefault(require("../../../lib/Form")),_Recipe=_interopRequireDefault(require("../../../models/Recipe")),_Service=_interopRequireDefault(require("../../../models/Service")),_Tabs=_interopRequireDefault(require("../../ui/Tabs/Tabs")),_TabItem=require("../../ui/Tabs/TabItem"),_Input=_interopRequireDefault(require("../../ui/Input")),_Toggle=_interopRequireDefault(require("../../ui/Toggle")),_Slider=_interopRequireDefault(require("../../ui/Slider")),_Button=_interopRequireDefault(require("../../ui/Button")),_ImageUpload=_interopRequireDefault(require("../../ui/ImageUpload")),_Select=_interopRequireDefault(require("../../ui/Select")),_environment=require("../../../environment"),_globalMessages=_interopRequireDefault(require("../../../i18n/globalMessages")),_icon=require("../../ui/icon"),_jsxRuntime=require("react/jsx-runtime");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const messages=(0,_reactIntl.defineMessages)({saveService:{id:"settings.service.form.saveButton",defaultMessage:[{type:0,value:"Save service"}]},deleteService:{id:"settings.service.form.deleteButton",defaultMessage:[{type:0,value:"Delete service"}]},openDarkmodeCss:{id:"settings.service.form.openDarkmodeCss",defaultMessage:[{type:0,value:"Open darkmode.css"}]},openUserCss:{id:"settings.service.form.openUserCss",defaultMessage:[{type:0,value:"Open user.css"}]},openUserJs:{id:"settings.service.form.openUserJs",defaultMessage:[{type:0,value:"Open user.js"}]},recipeFileInfo:{id:"settings.service.form.recipeFileInfo",defaultMessage:[{type:0,value:"Your user files will be inserted into the webpage so you can customize services in any way you like. User files are only stored locally and are not transferred to other computers using the same account."}]},availableServices:{id:"settings.service.form.availableServices",defaultMessage:[{type:0,value:"Available services"}]},yourServices:{id:"settings.service.form.yourServices",defaultMessage:[{type:0,value:"Your services"}]},addServiceHeadline:{id:"settings.service.form.addServiceHeadline",defaultMessage:[{type:0,value:"Add "},{type:1,value:"name"}]},editServiceHeadline:{id:"settings.service.form.editServiceHeadline",defaultMessage:[{type:0,value:"Edit "},{type:1,value:"name"}]},tabHosted:{id:"settings.service.form.tabHosted",defaultMessage:[{type:0,value:"Hosted"}]},tabOnPremise:{id:"settings.service.form.tabOnPremise",defaultMessage:[{type:0,value:"Self hosted ⭐️"}]},useHostedService:{id:"settings.service.form.useHostedService",defaultMessage:[{type:0,value:"Use the hosted "},{type:1,value:"name"},{type:0,value:" service."}]},customUrlValidationError:{id:"settings.service.form.customUrlValidationError",defaultMessage:[{type:0,value:"Could not validate custom "},{type:1,value:"name"},{type:0,value:" server."}]},indirectMessageInfo:{id:"settings.service.form.indirectMessageInfo",defaultMessage:[{type:0,value:"You will be notified about all new messages in a channel, not just @username, @channel, @here, ..."}]},isMutedInfo:{id:"settings.service.form.isMutedInfo",defaultMessage:[{type:0,value:"When disabled, all notification sounds and audio playback are muted"}]},isHibernationEnabledInfo:{id:"settings.service.form.isHibernatedEnabledInfo",defaultMessage:[{type:0,value:"When enabled, a service will be shut down after a period of time to save system resources."}]},headlineNotifications:{id:"settings.service.form.headlineNotifications",defaultMessage:[{type:0,value:"Notifications"}]},headlineBadges:{id:"settings.service.form.headlineBadges",defaultMessage:[{type:0,value:"Unread message badges"}]},headlineGeneral:{id:"settings.service.form.headlineGeneral",defaultMessage:[{type:0,value:"General"}]},headlineDarkReaderSettings:{id:"settings.service.form.headlineDarkReaderSettings",defaultMessage:[{type:0,value:"Dark Reader Settings"}]},iconDelete:{id:"settings.service.form.iconDelete",defaultMessage:[{type:0,value:"Delete"}]},iconUpload:{id:"settings.service.form.iconUpload",defaultMessage:[{type:0,value:"Drop your image, or click here"}]},headlineProxy:{id:"settings.service.form.proxy.headline",defaultMessage:[{type:0,value:"HTTP/HTTPS Proxy Settings"}]},proxyRestartInfo:{id:"settings.service.form.proxy.restartInfo",defaultMessage:[{type:0,value:"Please restart Ferdi after changing proxy Settings."}]},proxyInfo:{id:"settings.service.form.proxy.info",defaultMessage:[{type:0,value:"Proxy settings will not be synchronized with the Ferdi servers."}]}});class EditServiceForm extends _react.Component{constructor(...e){super(...e),this.state={isValidatingCustomUrl:!1}}submit(e){const{recipe:s}=this.props;e.preventDefault(),this.props.form.submit({onSuccess:async e=>{const t=e.values();let i=!0;const{files:a}=e.$("customIcon");if(a&&(t.iconFile=a[0]),s.validateUrl&&t.customUrl){this.setState({isValidatingCustomUrl:!0});try{t.customUrl=(0,_normalizeUrl.default)(t.customUrl,{stripAuthentication:!1,stripWWW:!1,removeTrailingSlash:!1}),i=await s.validateUrl(t.customUrl)}catch(e){console.warn("ValidateURL",e),i=!1}}i?this.props.onSubmit(t):e.invalidate("url-validation-error"),this.setState({isValidatingCustomUrl:!1})},onError:()=>{}})}render(){const{recipe:e,service:s,action:t,form:i,isSaving:a,isDeleting:r,onDelete:n,openRecipeFile:l,isProxyFeatureEnabled:o}=this.props,{intl:d}=this.props,{isValidatingCustomUrl:u}=this.state,m=r?(0,_jsxRuntime.jsx)(_Button.default,{label:d.formatMessage(messages.deleteService),loaded:!1,buttonType:"secondary",className:"settings__delete-button",disabled:!0}):(0,_jsxRuntime.jsx)(_Button.default,{buttonType:"danger",label:d.formatMessage(messages.deleteService),className:"settings__delete-button",onClick:n});let c=0;e.hasHostedOption&&s.team?c=1:e.hasHostedOption&&s.customUrl&&(c=2);const _=!e.hasHostedOption&&(e.hasTeamId||e.hasCustomUrl);return(0,_jsxRuntime.jsxs)("div",{className:"settings__main",children:[(0,_jsxRuntime.jsxs)("div",{className:"settings__header",children:[(0,_jsxRuntime.jsx)("span",{className:"settings__header-item",children:"add"===t?(0,_jsxRuntime.jsx)(_reactRouter.Link,{to:"/settings/recipes",children:d.formatMessage(messages.availableServices)}):(0,_jsxRuntime.jsx)(_reactRouter.Link,{to:"/settings/services",children:d.formatMessage(messages.yourServices)})}),(0,_jsxRuntime.jsx)("span",{className:"separator"}),(0,_jsxRuntime.jsx)("span",{className:"settings__header-item",children:"add"===t?d.formatMessage(messages.addServiceHeadline,{name:e.name}):d.formatMessage(messages.editServiceHeadline,{name:""!==s.name?s.name:e.name})})]}),(0,_jsxRuntime.jsxs)("div",{className:"settings__body",children:[(0,_jsxRuntime.jsxs)("form",{onSubmit:e=>this.submit(e),id:"form",children:[(0,_jsxRuntime.jsx)("div",{className:"service-name",children:(0,_jsxRuntime.jsx)(_Input.default,{field:i.$("name"),focus:!0})}),(e.hasTeamId||e.hasCustomUrl)&&(0,_jsxRuntime.jsxs)(_Tabs.default,{active:c,children:[e.hasHostedOption&&(0,_jsxRuntime.jsx)(_TabItem.TabItem,{title:e.name,children:d.formatMessage(messages.useHostedService,{name:e.name})}),e.hasTeamId&&(0,_jsxRuntime.jsx)(_TabItem.TabItem,{title:d.formatMessage(messages.tabHosted),children:(0,_jsxRuntime.jsx)(_Input.default,{field:i.$("team"),prefix:e.urlInputPrefix,suffix:e.urlInputSuffix})}),e.hasCustomUrl&&(0,_jsxRuntime.jsxs)(_TabItem.TabItem,{title:d.formatMessage(messages.tabOnPremise),children:[(0,_jsxRuntime.jsx)(_Input.default,{field:i.$("customUrl")}),"url-validation-error"===i.error&&(0,_jsxRuntime.jsx)("p",{className:"franz-form__error",children:d.formatMessage(messages.customUrlValidationError,{name:e.name})})]})]}),e.message&&(0,_jsxRuntime.jsxs)("p",{className:"settings__message",style:{marginTop:0},children:[(0,_jsxRuntime.jsx)(_icon.Icon,{icon:_js.mdiInformation}),e.message]}),(0,_jsxRuntime.jsxs)("div",{className:"service-flex-grid",children:[(0,_jsxRuntime.jsxs)("div",{className:"settings__options",children:[(0,_jsxRuntime.jsxs)("div",{className:"settings__settings-group",children:[(0,_jsxRuntime.jsx)("h3",{children:d.formatMessage(messages.headlineNotifications)}),(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("isNotificationEnabled")}),(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("isMuted")}),(0,_jsxRuntime.jsx)("p",{className:"settings__help indented__help",children:d.formatMessage(messages.isMutedInfo)})]}),(0,_jsxRuntime.jsxs)("div",{className:"settings__settings-group",children:[(0,_jsxRuntime.jsx)("h3",{children:d.formatMessage(messages.headlineBadges)}),(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("isBadgeEnabled")}),e.hasIndirectMessages&&i.$("isBadgeEnabled").value&&(0,_jsxRuntime.jsxs)(_jsxRuntime.Fragment,{children:[(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("isIndirectMessageBadgeEnabled")}),(0,_jsxRuntime.jsx)("p",{className:"settings__help indented__help",children:d.formatMessage(messages.indirectMessageInfo)})]}),e.allowFavoritesDelineationInUnreadCount&&(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("onlyShowFavoritesInUnreadCount")})]}),(0,_jsxRuntime.jsxs)("div",{className:"settings__settings-group",children:[(0,_jsxRuntime.jsx)("h3",{children:d.formatMessage(messages.headlineGeneral)}),(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("isEnabled")}),(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("isHibernationEnabled")}),(0,_jsxRuntime.jsx)("p",{className:"settings__help indented__help",children:d.formatMessage(messages.isHibernationEnabledInfo)}),(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("isWakeUpEnabled")}),(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("isDarkModeEnabled")}),i.$("isDarkModeEnabled").value&&(0,_jsxRuntime.jsxs)(_jsxRuntime.Fragment,{children:[(0,_jsxRuntime.jsx)("h3",{children:d.formatMessage(messages.headlineDarkReaderSettings)}),(0,_jsxRuntime.jsx)(_Slider.default,{field:i.$("darkReaderBrightness")}),(0,_jsxRuntime.jsx)(_Slider.default,{field:i.$("darkReaderContrast")}),(0,_jsxRuntime.jsx)(_Slider.default,{field:i.$("darkReaderSepia")})]})]})]}),(0,_jsxRuntime.jsx)("div",{className:"service-icon",children:(0,_jsxRuntime.jsx)(_ImageUpload.default,{field:i.$("customIcon"),textDelete:d.formatMessage(messages.iconDelete),textUpload:d.formatMessage(messages.iconUpload)})})]}),!_environment.isMac&&(0,_jsxRuntime.jsx)("div",{className:"settings__settings-group",children:(0,_jsxRuntime.jsx)(_Select.default,{field:i.$("spellcheckerLanguage")})}),o&&(0,_jsxRuntime.jsxs)("div",{className:"settings__settings-group",children:[(0,_jsxRuntime.jsxs)("h3",{children:[d.formatMessage(messages.headlineProxy),(0,_jsxRuntime.jsx)("span",{className:"badge badge--success",children:"beta"})]}),(0,_jsxRuntime.jsx)(_Toggle.default,{field:i.$("proxy.isEnabled")}),i.$("proxy.isEnabled").value&&(0,_jsxRuntime.jsxs)(_jsxRuntime.Fragment,{children:[(0,_jsxRuntime.jsx)("div",{className:"grid",children:(0,_jsxRuntime.jsxs)("div",{className:"grid__row",children:[(0,_jsxRuntime.jsx)(_Input.default,{field:i.$("proxy.host"),className:"proxyHost"}),(0,_jsxRuntime.jsx)(_Input.default,{field:i.$("proxy.port")})]})}),(0,_jsxRuntime.jsx)("div",{className:"grid",children:(0,_jsxRuntime.jsxs)("div",{className:"grid__row",children:[(0,_jsxRuntime.jsx)(_Input.default,{field:i.$("proxy.user")}),(0,_jsxRuntime.jsx)(_Input.default,{field:i.$("proxy.password"),showPasswordToggle:!0})]})}),(0,_jsxRuntime.jsxs)("p",{children:[(0,_jsxRuntime.jsx)(_icon.Icon,{icon:_js.mdiInformation}),d.formatMessage(messages.proxyRestartInfo)]}),(0,_jsxRuntime.jsxs)("p",{children:[(0,_jsxRuntime.jsx)(_icon.Icon,{icon:_js.mdiInformation}),d.formatMessage(messages.proxyInfo)]})]})]}),(0,_jsxRuntime.jsxs)("div",{className:"user-agent",children:[(0,_jsxRuntime.jsx)(_Input.default,{field:i.$("userAgentPref")}),(0,_jsxRuntime.jsx)("p",{className:"settings__help",children:d.formatMessage(_globalMessages.default.userAgentHelp)})]})]}),"edit"===t&&(0,_jsxRuntime.jsxs)(_jsxRuntime.Fragment,{children:[(0,_jsxRuntime.jsxs)("div",{className:"settings__open-recipe-file-container",children:[(0,_jsxRuntime.jsx)(_Button.default,{buttonType:"secondary",label:d.formatMessage(messages.openDarkmodeCss),className:"settings__open-recipe-file-button",onClick:()=>l("darkmode.css")}),(0,_jsxRuntime.jsx)(_Button.default,{buttonType:"secondary",label:d.formatMessage(messages.openUserCss),className:"settings__open-recipe-file-button",onClick:()=>l("user.css")}),(0,_jsxRuntime.jsx)(_Button.default,{buttonType:"secondary",label:d.formatMessage(messages.openUserJs),className:"settings__open-recipe-file-button",onClick:()=>l("user.js")})]}),(0,_jsxRuntime.jsxs)("p",{style:{marginTop:10,marginBottom:10},children:[(0,_jsxRuntime.jsx)(_icon.Icon,{icon:_js.mdiInformation}),d.formatMessage(messages.recipeFileInfo)]})]}),(0,_jsxRuntime.jsxs)("span",{style:{fontStyle:"italic",fontSize:"80%"},children:["Recipe version:",e.version]})]}),(0,_jsxRuntime.jsxs)("div",{className:"settings__controls",children:["edit"===t&&m,a||u?(0,_jsxRuntime.jsx)(_Button.default,{type:"submit",label:d.formatMessage(messages.saveService),loaded:!1,buttonType:"secondary",disabled:!0}):(0,_jsxRuntime.jsx)(_Button.default,{type:"submit",label:d.formatMessage(messages.saveService),htmlForm:"form",disabled:"edit"!==t&&i.isPristine&&_})]})]})}}EditServiceForm.propTypes={recipe:_propTypes.default.instanceOf(_Recipe.default).isRequired,service:(e,s)=>"edit"!==e.action||e[s]instanceof _Service.default?null:new Error(`'${s}'' is expected to be of type 'Service'\n          when editing a Service`),action:_propTypes.default.string.isRequired,form:_propTypes.default.instanceOf(_Form.default).isRequired,onSubmit:_propTypes.default.func.isRequired,onDelete:_propTypes.default.func.isRequired,openRecipeFile:_propTypes.default.func.isRequired,isSaving:_propTypes.default.bool.isRequired,isDeleting:_propTypes.default.bool.isRequired,isProxyFeatureEnabled:_propTypes.default.bool.isRequired},EditServiceForm.defaultProps={service:{}};var _default=(0,_reactIntl.injectIntl)((0,_mobxReact.observer)(EditServiceForm));exports.default=_default;