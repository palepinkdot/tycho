"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_descriptor6,_descriptor7,_descriptor8,_descriptor9,_descriptor10,_mobx=require("mobx"),_mobxLocalstorage=_interopRequireDefault(require("mobx-localstorage")),_themes=require("../../themes"),_actions=require("./actions"),_config=require("../../config"),_urlHelpers=require("../../helpers/url-helpers"),_FeatureStore=require("../utils/FeatureStore"),_Reaction=require("../../stores/lib/Reaction"),_ActionBinding=require("../utils/ActionBinding"),_constants=require("./constants"),_UserAgent=_interopRequireDefault(require("../../models/UserAgent"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _initializerDefineProperty(e,t,i,s){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(s):void 0})}function _applyDecoratedDescriptor(e,t,i,s,o){var r={};return Object.keys(s).forEach((function(e){r[e]=s[e]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),r),o&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(o):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(e,t,r),r=null),r}function _initializerWarningHelper(e,t){throw new Error("Decorating class property failed. Please ensure that proposal-class-properties is enabled and runs after the decorators transform.")}const debug=require("debug")("Ferdi:feature:todos:store");let TodoStore=(_class=class extends _FeatureStore.FeatureStore{constructor(...e){super(...e),_initializerDefineProperty(this,"stores",_descriptor,this),_initializerDefineProperty(this,"isFeatureActive",_descriptor2,this),_initializerDefineProperty(this,"webview",_descriptor3,this),_initializerDefineProperty(this,"userAgentModel",_descriptor4,this),this.isInitialized=!1,this._updateSettings=e=>{_mobxLocalstorage.default.setItem("todos",{...this.settings,...e})},_initializerDefineProperty(this,"_resize",_descriptor5,this),_initializerDefineProperty(this,"_toggleTodosPanel",_descriptor6,this),_initializerDefineProperty(this,"_setTodosWebview",_descriptor7,this),_initializerDefineProperty(this,"_handleHostMessage",_descriptor8,this),_initializerDefineProperty(this,"_handleClientMessage",_descriptor9,this),this._handleNewWindowEvent=({url:e})=>{this.actions.app.openExternalUrl({url:e})},_initializerDefineProperty(this,"_toggleTodosFeatureVisibility",_descriptor10,this),this._openDevTools=()=>{debug("_openDevTools");const e=document.querySelector("#todos-panel webview");e&&e.openDevTools()},this._reload=()=>{debug("_reload");const e=document.querySelector("#todos-panel webview");e&&e.reload()},this._onTodosClientInitialized=async()=>{const{authToken:e}=this.stores.user,{isDarkThemeActive:t}=this.stores.ui,{locale:i}=this.stores.app;this.webview&&(await this.webview.send(_constants.IPC.TODOS_HOST_CHANNEL,{action:"todos:configure",data:{authToken:e,locale:i,theme:t?_themes.ThemeType.dark:_themes.ThemeType.default}}),this.isInitialized||(this.webview.addEventListener("new-window",this._handleNewWindowEvent),this.isInitialized=!0))},this._goToService=({url:e,serviceId:t})=>{e&&this.stores.services.one(t).webview.loadURL(e),this.actions.service.setActive({serviceId:t})},this._updateTodosConfig=()=>{this._onTodosClientInitialized()},this._firstLaunchReaction=()=>{const{stats:e}=this.stores.settings.all;void 0===this.settings.isFeatureEnabledByUser&&this._updateSettings({isFeatureEnabledByUser:_config.DEFAULT_IS_FEATURE_ENABLED_BY_USER}),e.appStarts<=1?this._updateSettings({isTodosPanelVisible:!1}):e.appStarts<=2&&this._updateSettings({isTodosPanelVisible:!0})},this._routeCheckReaction=()=>{const{pathname:e}=this.stores.router.location;e===_constants.TODOS_ROUTES.TARGET&&(debug("Router is on todos route, show todos panel"),this.stores.router.push("/"),this.isTodosPanelVisible||this._updateSettings({isTodosPanelVisible:!0}))}}get width(){const e=this.settings.width||_config.DEFAULT_TODOS_WIDTH;return e<_config.TODOS_MIN_WIDTH?_config.TODOS_MIN_WIDTH:e}get isTodosPanelForceHidden(){return!this.isFeatureEnabledByUser}get isTodosPanelVisible(){return void 0===this.settings.isTodosPanelVisible?_config.DEFAULT_TODOS_VISIBLE:this.settings.isTodosPanelVisible}get isFeatureEnabledByUser(){return this.settings.isFeatureEnabledByUser}get settings(){return _mobxLocalstorage.default.getItem("todos")||{}}get userAgent(){return this.userAgentModel.userAgent}get isUsingPredefinedTodoServer(){return this.stores&&this.stores.settings.app.predefinedTodoServer!==_config.CUSTOM_TODO_SERVICE}get todoUrl(){return this.stores?this.isUsingPredefinedTodoServer?this.stores.settings.app.predefinedTodoServer:this.stores.settings.app.customTodoServer:null}get isTodoUrlValid(){return!this.isUsingPredefinedTodoServer||(0,_urlHelpers.isValidExternalURL)(this.todoUrl)}get todoRecipeId(){return this.isFeatureEnabledByUser&&this.isUsingPredefinedTodoServer&&this.todoUrl in _config.TODO_SERVICE_RECIPE_IDS?_config.TODO_SERVICE_RECIPE_IDS[this.todoUrl]:null}start(e,t){debug("TodoStore::start"),this.stores=e,this.actions=t,this._registerActions((0,_ActionBinding.createActionBindings)([[_actions.todoActions.resize,this._resize],[_actions.todoActions.toggleTodosPanel,this._toggleTodosPanel],[_actions.todoActions.setTodosWebview,this._setTodosWebview],[_actions.todoActions.handleHostMessage,this._handleHostMessage],[_actions.todoActions.handleClientMessage,this._handleClientMessage],[_actions.todoActions.toggleTodosFeatureVisibility,this._toggleTodosFeatureVisibility],[_actions.todoActions.openDevTools,this._openDevTools],[_actions.todoActions.reload,this._reload]])),this._allReactions=(0,_Reaction.createReactions)([this._updateTodosConfig,this._firstLaunchReaction,this._routeCheckReaction]),this._registerReactions(this._allReactions),this.isFeatureActive=!0}stop(){super.stop(),debug("TodoStore::stop"),this.reset(),this.isFeatureActive=!1}},_descriptor=_applyDecoratedDescriptor(_class.prototype,"stores",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"isFeatureActive",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"webview",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"userAgentModel",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _UserAgent.default}}),_applyDecoratedDescriptor(_class.prototype,"width",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"width"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isTodosPanelForceHidden",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isTodosPanelForceHidden"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isTodosPanelVisible",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isTodosPanelVisible"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isFeatureEnabledByUser",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isFeatureEnabledByUser"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"settings",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"settings"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"userAgent",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"userAgent"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isUsingPredefinedTodoServer",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isUsingPredefinedTodoServer"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"todoUrl",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"todoUrl"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isTodoUrlValid",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isTodoUrlValid"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"todoRecipeId",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"todoRecipeId"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"start",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"start"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"stop",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"stop"),_class.prototype),_descriptor5=_applyDecoratedDescriptor(_class.prototype,"_resize",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return({width:e})=>{this._updateSettings({width:e})}}}),_descriptor6=_applyDecoratedDescriptor(_class.prototype,"_toggleTodosPanel",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return()=>{this._updateSettings({isTodosPanelVisible:!this.isTodosPanelVisible})}}}),_descriptor7=_applyDecoratedDescriptor(_class.prototype,"_setTodosWebview",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return({webview:e})=>{debug("_setTodosWebview",e),this.webview!==e&&(this.webview=e,this.userAgentModel.setWebviewReference(e))}}}),_descriptor8=_applyDecoratedDescriptor(_class.prototype,"_handleHostMessage",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return e=>{debug("_handleHostMessage",e),"todos:create"===e.action&&this.webview.send(_constants.IPC.TODOS_HOST_CHANNEL,e)}}}),_descriptor9=_applyDecoratedDescriptor(_class.prototype,"_handleClientMessage",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return({channel:e,message:t={}})=>{switch(debug("_handleClientMessage",e,t),t.action){case"todos:initialized":this._onTodosClientInitialized();break;case"todos:goToService":this._goToService(t.data);break;default:debug("Other message received",e,t),this.stores.services.isTodosServiceAdded&&this.actions.service.handleIPCMessage({serviceId:this.stores.services.isTodosServiceAdded.id,channel:e,args:t})}}}}),_descriptor10=_applyDecoratedDescriptor(_class.prototype,"_toggleTodosFeatureVisibility",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return()=>{debug("_toggleTodosFeatureVisibility"),this._updateSettings({isFeatureEnabledByUser:!this.settings.isFeatureEnabledByUser})}}}),_class);exports.default=TodoStore;