"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_descriptor5,_descriptor6,_descriptor7,_descriptor8,_descriptor9,_descriptor10,_descriptor11,_descriptor12,_descriptor13,_descriptor14,_descriptor15,_descriptor16,_mobx=require("mobx"),_mobxLocalstorage=_interopRequireDefault(require("mobx-localstorage")),_routingHelpers=require("../../helpers/routing-helpers"),_actions=require("./actions"),_FeatureStore=require("../utils/FeatureStore"),_api=require("./api"),_constants=require("./constants"),_Reaction=require("../../stores/lib/Reaction"),_ActionBinding=require("../utils/ActionBinding"),_config=require("../../config");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _initializerDefineProperty(e,t,r,i){r&&Object.defineProperty(e,t,{enumerable:r.enumerable,configurable:r.configurable,writable:r.writable,value:r.initializer?r.initializer.call(i):void 0})}function _applyDecoratedDescriptor(e,t,r,i,s){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=r.slice().reverse().reduce((function(r,i){return i(e,t,r)||r}),o),s&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(s):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}function _initializerWarningHelper(e,t){throw new Error("Decorating class property failed. Please ensure that proposal-class-properties is enabled and runs after the decorators transform.")}const debug=require("debug")("Ferdi:feature:workspaces:store");let WorkspacesStore=(_class=class extends _FeatureStore.FeatureStore{constructor(...e){super(...e),_initializerDefineProperty(this,"isFeatureActive",_descriptor,this),_initializerDefineProperty(this,"activeWorkspace",_descriptor2,this),_initializerDefineProperty(this,"nextWorkspace",_descriptor3,this),_initializerDefineProperty(this,"workspaceBeingEdited",_descriptor4,this),_initializerDefineProperty(this,"isSwitchingWorkspace",_descriptor5,this),_initializerDefineProperty(this,"isWorkspaceDrawerOpen",_descriptor6,this),_initializerDefineProperty(this,"isSettingsRouteActive",_descriptor7,this),this._wasDrawerOpenBeforeSettingsRoute=null,this._allActions=[],this._allReactions=[],this.filterServicesByActiveWorkspace=e=>{const{activeWorkspace:t,isFeatureActive:r}=this;return r&&t?this.getWorkspaceServices(t):e},this._getWorkspaceById=e=>this.workspaces.find((t=>t.id===e)),this._updateSettings=e=>{_mobxLocalstorage.default.setItem("workspaces",{...this.settings,...e})},_initializerDefineProperty(this,"_edit",_descriptor8,this),_initializerDefineProperty(this,"_create",_descriptor9,this),_initializerDefineProperty(this,"_delete",_descriptor10,this),_initializerDefineProperty(this,"_update",_descriptor11,this),_initializerDefineProperty(this,"_setActiveWorkspace",_descriptor12,this),_initializerDefineProperty(this,"_deactivateActiveWorkspace",_descriptor13,this),_initializerDefineProperty(this,"_toggleWorkspaceDrawer",_descriptor14,this),_initializerDefineProperty(this,"_openWorkspaceSettings",_descriptor15,this),_initializerDefineProperty(this,"reorderServicesOfActiveWorkspace",_descriptor16,this),this._toggleKeepAllWorkspacesLoadedSetting=async()=>{this._updateSettings({keepAllWorkspacesLoaded:!this.settings.keepAllWorkspacesLoaded})},this._setWorkspaceBeingEditedReaction=()=>{const{pathname:e}=this.stores.router.location,t=(0,_routingHelpers.matchRoute)("/settings/workspaces/edit/:id",e);t&&(this.workspaceBeingEdited=this._getWorkspaceById(t.id))},this._setActiveServiceOnWorkspaceSwitchReaction=()=>{if(this.isFeatureActive&&this.activeWorkspace){const e=this.stores.services.active,t=this.getWorkspaceServices(this.activeWorkspace);if(t.length<=0)return;t.includes(e)||this.actions.service.setActive({serviceId:t[0].id,keepActiveRoute:!0})}},this._activateLastUsedWorkspaceReaction=()=>{if(debug("_activateLastUsedWorkspaceReaction"),!this.activeWorkspace&&this.userHasWorkspaces){const{lastActiveWorkspace:e}=this.settings;if(e){const t=this._getWorkspaceById(e);t&&this._setActiveWorkspace({workspace:t})}}},this._openDrawerWithSettingsReaction=()=>{const{router:e}=this.stores,t=e.location.pathname.includes(_constants.WORKSPACES_ROUTES.ROOT),r=!this.isSettingsRouteActive&&t,i=!t&&this.isSettingsRouteActive;r?(this.isSettingsRouteActive=!0,this._wasDrawerOpenBeforeSettingsRoute=this.isWorkspaceDrawerOpen,this._wasDrawerOpenBeforeSettingsRoute||_actions.workspaceActions.toggleWorkspaceDrawer()):i&&(this.isSettingsRouteActive=!1,!this._wasDrawerOpenBeforeSettingsRoute&&this.isWorkspaceDrawerOpen&&_actions.workspaceActions.toggleWorkspaceDrawer())},this._cleanupInvalidServiceReferences=()=>{const{services:e}=this.stores,{allServicesRequest:t}=e,r=t.wasExecuted&&!t.isError;for(const t of this.workspaces)for(const i of t.services)r&&!e.one(i)&&i!==_config.KEEP_WS_LOADED_USID&&t.services.remove(i)}}get workspaces(){return this.isFeatureActive&&_api.getUserWorkspacesRequest.result||[]}get isLoadingWorkspaces(){return!!this.isFeatureActive&&_api.getUserWorkspacesRequest.isExecutingFirstTime}get settings(){return _mobxLocalstorage.default.getItem("workspaces")||{}}get userHasWorkspaces(){return _api.getUserWorkspacesRequest.wasExecuted&&this.workspaces.length>0}get isUserAllowedToUseFeature(){return!0}get isAnyWorkspaceActive(){return!!this.activeWorkspace}start(e,t){debug("WorkspacesStore::start"),this.stores=e,this.actions=t,this._allActions=(0,_ActionBinding.createActionBindings)([[_actions.workspaceActions.toggleWorkspaceDrawer,this._toggleWorkspaceDrawer],[_actions.workspaceActions.openWorkspaceSettings,this._openWorkspaceSettings],[_actions.workspaceActions.edit,this._edit],[_actions.workspaceActions.create,this._create],[_actions.workspaceActions.delete,this._delete],[_actions.workspaceActions.update,this._update],[_actions.workspaceActions.activate,this._setActiveWorkspace],[_actions.workspaceActions.deactivate,this._deactivateActiveWorkspace],[_actions.workspaceActions.toggleKeepAllWorkspacesLoadedSetting,this._toggleKeepAllWorkspacesLoadedSetting]]),this._registerActions(this._allActions),this._allReactions=(0,_Reaction.createReactions)([this._openDrawerWithSettingsReaction,this._cleanupInvalidServiceReferences,this._setActiveServiceOnWorkspaceSwitchReaction,this._activateLastUsedWorkspaceReaction,this._setWorkspaceBeingEditedReaction]),this._registerReactions(this._allReactions),this.isFeatureActive=!0}reset(){this.activeWorkspace=null,this.nextWorkspace=null,this.workspaceBeingEdited=null,this.isSwitchingWorkspace=!1,this.isWorkspaceDrawerOpen=!1}stop(){super.stop(),debug("WorkspacesStore::stop"),this.reset(),this.isFeatureActive=!1}getWorkspaceServices(e){const{services:t}=this.stores;return e.services.map((e=>t.one(e))).filter((e=>!!e))}},_descriptor=_applyDecoratedDescriptor(_class.prototype,"isFeatureActive",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"activeWorkspace",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"nextWorkspace",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"workspaceBeingEdited",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_descriptor5=_applyDecoratedDescriptor(_class.prototype,"isSwitchingWorkspace",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor6=_applyDecoratedDescriptor(_class.prototype,"isWorkspaceDrawerOpen",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor7=_applyDecoratedDescriptor(_class.prototype,"isSettingsRouteActive",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_applyDecoratedDescriptor(_class.prototype,"workspaces",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"workspaces"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isLoadingWorkspaces",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isLoadingWorkspaces"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"settings",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"settings"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"userHasWorkspaces",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"userHasWorkspaces"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isUserAllowedToUseFeature",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isUserAllowedToUseFeature"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"isAnyWorkspaceActive",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"isAnyWorkspaceActive"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"start",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"start"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"reset",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"reset"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"stop",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"stop"),_class.prototype),_descriptor8=_applyDecoratedDescriptor(_class.prototype,"_edit",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return({workspace:e})=>{this.stores.router.push(`/settings/workspaces/edit/${e.id}`)}}}),_descriptor9=_applyDecoratedDescriptor(_class.prototype,"_create",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return async({name:e})=>{const t=await _api.createWorkspaceRequest.execute(e);await _api.getUserWorkspacesRequest.result.push(t),this._edit({workspace:t})}}}),_descriptor10=_applyDecoratedDescriptor(_class.prototype,"_delete",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return async({workspace:e})=>{await _api.deleteWorkspaceRequest.execute(e),await _api.getUserWorkspacesRequest.result.remove(e),this.stores.router.push("/settings/workspaces"),this.activeWorkspace===e&&this._deactivateActiveWorkspace()}}}),_descriptor11=_applyDecoratedDescriptor(_class.prototype,"_update",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return async({workspace:e})=>{await _api.updateWorkspaceRequest.execute(e);const t=this._getWorkspaceById(e.id);Object.assign(t,e),this.stores.router.push("/settings/workspaces")}}}),_descriptor12=_applyDecoratedDescriptor(_class.prototype,"_setActiveWorkspace",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return({workspace:e})=>{this.isSwitchingWorkspace=!0,this.nextWorkspace=e,setTimeout((()=>{this.activeWorkspace=e,this._updateSettings({lastActiveWorkspace:e.id})}),100),setTimeout((()=>{if(this.isSwitchingWorkspace=!1,this.nextWorkspace=null,this.stores.settings.app.splitMode){const t=new Set(this.getWorkspaceServices(e).map((e=>e.name)));for(const e of document.querySelectorAll(".services__webview-wrapper"))e.style.display=t.has(e.dataset.name)?"":"none"}}),500)}}}),_descriptor13=_applyDecoratedDescriptor(_class.prototype,"_deactivateActiveWorkspace",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return()=>{this.isSwitchingWorkspace=!0,this.nextWorkspace=null,this._updateSettings({lastActiveWorkspace:null}),setTimeout((()=>{this.activeWorkspace=null}),100),setTimeout((()=>{if(this.isSwitchingWorkspace=!1,this.stores.settings.app.splitMode)for(const e of document.querySelectorAll(".services__webview-wrapper"))e.style.display=""}),500)}}}),_descriptor14=_applyDecoratedDescriptor(_class.prototype,"_toggleWorkspaceDrawer",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return()=>{this.isWorkspaceDrawerOpen=!this.isWorkspaceDrawerOpen}}}),_descriptor15=_applyDecoratedDescriptor(_class.prototype,"_openWorkspaceSettings",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return()=>{this.actions.ui.openSettings({path:"workspaces"})}}}),_descriptor16=_applyDecoratedDescriptor(_class.prototype,"reorderServicesOfActiveWorkspace",[_mobx.action],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return async({oldIndex:e,newIndex:t})=>{const{activeWorkspace:r}=this,{services:i}=r;i.splice(t,0,i.splice(e,1)[0]),await _api.updateWorkspaceRequest.execute(r)}}}),_class);exports.default=WorkspacesStore;