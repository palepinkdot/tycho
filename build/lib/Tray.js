"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _electron=require("electron"),_path=require("path"),_macosVersion=_interopRequireDefault(require("macos-version")),_environment=require("../environment");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const FILE_EXTENSION=_environment.isWindows?"ico":"png",INDICATOR_TRAY_PLAIN="tray",INDICATOR_TRAY_UNREAD="tray-unread",INDICATOR_TRAY_INDIRECT="tray-indirect";class TrayIcon{constructor(){this.trayIcon=null,this.indicator=0,this.themeChangeSubscriberId=null,this.trayMenu=null,this.visible=!1,this.isAppMuted=!1,this.mainWindow=null,this.trayMenuTemplate=e=>[{label:e.mainWindow.isVisible()&&e.mainWindow.isFocused()?"Hide Ferdi":"Show Ferdi",click(){e._toggleWindow()}},{label:e.isAppMuted?"Enable Notifications && Audio":"Disable Notifications && Audio",click(){e.mainWindow&&e.mainWindow.webContents.send("muteApp")}},{label:"Quit Ferdi",click(){_electron.app.quit()}}],_electron.ipcMain.on("initialAppSettings",((e,t)=>{this._updateTrayMenu(t)})),_electron.ipcMain.on("updateAppSettings",((e,t)=>{this._updateTrayMenu(t)})),this.mainWindow=_electron.BrowserWindow.getAllWindows()[0],this.mainWindow.on("hide",(()=>{this._updateTrayMenu(null)})),this.mainWindow.on("restore",(()=>{this._updateTrayMenu(null)})),this.mainWindow.on("minimize",(()=>{this._updateTrayMenu(null)})),this.mainWindow.on("show",(()=>{this._updateTrayMenu(null)})),this.mainWindow.on("focus",(()=>{this._updateTrayMenu(null)})),this.mainWindow.on("blur",(()=>{this._updateTrayMenu(null)}))}_updateTrayMenu(e){this.trayIcon&&(e&&"app"===e.type&&(this.isAppMuted=e.data.isAppMuted),this.trayMenu=_electron.Menu.buildFromTemplate(this.trayMenuTemplate(this)),_environment.isLinux&&this.trayIcon.setContextMenu(this.trayMenu))}show(){this.visible=!0,this._show()}_show(){this.trayIcon||(this.trayIcon=new _electron.Tray(this._getAsset("tray","tray")),this.trayIcon.setToolTip("Ferdi"),this.trayMenu=_electron.Menu.buildFromTemplate(this.trayMenuTemplate(this)),_environment.isLinux&&this.trayIcon.setContextMenu(this.trayMenu),this.trayIcon.on("click",(()=>{this._toggleWindow()})),(_environment.isMac||_environment.isWindows)&&this.trayIcon.on("right-click",(()=>{this.trayIcon.popUpContextMenu(this.trayMenu)})),_environment.isMac&&(this.themeChangeSubscriberId=_electron.systemPreferences.subscribeNotification("AppleInterfaceThemeChangedNotification",(()=>{this._refreshIcon()}))))}_toggleWindow(){const e=_electron.BrowserWindow.getAllWindows()[0];e&&(e.isMinimized()?e.restore():e.isVisible()&&e.isFocused()?_environment.isMac&&e.isFullScreen()?(e.once("show",(()=>e?.setFullScreen(!0))),e.once("leave-full-screen",(()=>e?.hide())),e.setFullScreen(!1)):e.hide():(e.show(),e.focus()))}hide(){this.visible=!1,this._hide()}_hide(){this.trayIcon&&(this.trayIcon.destroy(),this.trayIcon=null,_environment.isMac&&this.themeChangeSubscriberId&&(_electron.systemPreferences.unsubscribeNotification(this.themeChangeSubscriberId),this.themeChangeSubscriberId=null))}recreateIfVisible(){this.visible&&(this._hide(),setTimeout((()=>{this.visible&&this._show()}),100))}setIndicator(e){this.indicator=e,this._refreshIcon()}_getAssetFromIndicator(e){return"â€¢"===e?"tray-indirect":0!==e?"tray-unread":"tray"}_refreshIcon(){this.trayIcon&&(this.trayIcon.setImage(this._getAsset("tray",this._getAssetFromIndicator(this.indicator))),_environment.isMac&&this.trayIcon.setPressedImage(this._getAsset("tray",`${this._getAssetFromIndicator(this.indicator)}-active`)))}_getAsset(e,t){let{platform:i}=process;_environment.isMac&&(_electron.nativeTheme.shouldUseDarkColors||_macosVersion.default.isGreaterThanOrEqualTo("11"))&&(i=`${i}-dark`);const n=_electron.nativeImage.createFromPath((0,_path.join)(__dirname,"..","assets","images",e,i,`${t}.${FILE_EXTENSION}`));return _environment.isMac&&_macosVersion.default.isGreaterThanOrEqualTo("11")&&n.setTemplateImage(!0),n}}exports.default=TrayIcon;