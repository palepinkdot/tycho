"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _class,_descriptor,_descriptor2,_descriptor3,_mobx=require("mobx"),_fsExtra=require("fs-extra"),_semver=_interopRequireDefault(require("semver")),_Store=_interopRequireDefault(require("./lib/Store")),_CachedRequest=_interopRequireDefault(require("./lib/CachedRequest")),_Request=_interopRequireDefault(require("./lib/Request")),_routingHelpers=require("../helpers/routing-helpers"),_asarHelpers=require("../helpers/asar-helpers");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _initializerDefineProperty(e,t,i,r){i&&Object.defineProperty(e,t,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(r):void 0})}function _applyDecoratedDescriptor(e,t,i,r,s){var a={};return Object.keys(r).forEach((function(e){a[e]=r[e]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=i.slice().reverse().reduce((function(i,r){return r(e,t,i)||i}),a),s&&void 0!==a.initializer&&(a.value=a.initializer?a.initializer.call(s):void 0,a.initializer=void 0),void 0===a.initializer&&(Object.defineProperty(e,t,a),a=null),a}function _initializerWarningHelper(e,t){throw new Error("Decorating class property failed. Please ensure that proposal-class-properties is enabled and runs after the decorators transform.")}const debug=require("debug")("Ferdi:RecipeStore");let RecipesStore=(_class=class extends _Store.default{constructor(...e){super(...e),_initializerDefineProperty(this,"allRecipesRequest",_descriptor,this),_initializerDefineProperty(this,"installRecipeRequest",_descriptor2,this),_initializerDefineProperty(this,"getRecipeUpdatesRequest",_descriptor3,this),this.actions.recipe.install.listen(this._install.bind(this)),this.actions.recipe.update.listen(this._update.bind(this)),this.registerReactions([this._checkIfRecipeIsInstalled.bind(this)])}setup(){return this.all}get all(){return this.allRecipesRequest.execute().result||[]}get active(){const e=(0,_routingHelpers.matchRoute)("/settings/services/add/:id",this.stores.router.location.pathname);if(e){const t=this.one(e.id);if(t)return t;debug(`Recipe ${e.id} not installed`)}return null}get recipeIdForServices(){return this.stores.services.all.map((e=>e.recipe.id))}one(e){return this.all.find((t=>t.id===e))}isInstalled(e){return!!this.one(e)}async _install({recipeId:e}){const t=await this.installRecipeRequest.execute(e)._promise;return await this.allRecipesRequest.invalidate({immediately:!0})._promise,t}async _update(){const e=this.recipeIdForServices,t={};debug(`Check Recipe updates for ${this.all.map((e=>e.id))}`);for(const i of e){const e=this.one(i);t[i]=e.version}if(0===Object.keys(t).length)return;const i=await this.getRecipeUpdatesRequest.execute(t)._promise,r=(0,_asarHelpers.asarRecipesPath)("all.json"),s=(0,_fsExtra.readJSONSync)(r),a=[];for(const e of Object.keys(t)){const i=t[e],r=s.find((t=>t.id===e));r&&_semver.default.lt(i,r.version)&&a.push(e)}const o=[...i,...a];debug("Got update information (local, remote):",a,i);const l=o.length-1,c=async e=>{const t=o[e];this.actions.recipe.install({recipeId:t}),await this.installRecipeRequest._promise,this.installRecipeRequest.reset(),e===l?this.stores.ui.showServicesUpdatedInfoBar=!0:e<l&&c(e+1)};l>=0&&c(0)}async _checkIfRecipeIsInstalled(){const{router:e}=this.stores,t=e.location&&(0,_routingHelpers.matchRoute)("/settings/services/add/:id",e.location.pathname);if(t){const i=t.id;if(!this.stores.recipes.isInstalled(i)){e.push("/settings/recipes"),debug(`Recipe ${i} is not installed, trying to install it`);await this.installRecipeRequest.execute(i)._promise?(await this.allRecipesRequest.invalidate({immediately:!0})._promise,e.push(`/settings/services/add/${i}`)):e.push("/settings/recipes")}}}},_descriptor=_applyDecoratedDescriptor(_class.prototype,"allRecipesRequest",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _CachedRequest.default(this.api.recipes,"all")}}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"installRecipeRequest",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _Request.default(this.api.recipes,"install")}}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"getRecipeUpdatesRequest",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _Request.default(this.api.recipes,"update")}}),_applyDecoratedDescriptor(_class.prototype,"all",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"all"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"active",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"active"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"recipeIdForServices",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"recipeIdForServices"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"_update",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"_update"),_class.prototype),_class);exports.default=RecipesStore;