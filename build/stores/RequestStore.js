"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _class,_descriptor,_descriptor2,_descriptor3,_descriptor4,_electron=require("electron"),_mobx=require("mobx"),_ms=_interopRequireDefault(require("ms")),_Store=_interopRequireDefault(require("./lib/Store"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _initializerDefineProperty(e,r,t,s){t&&Object.defineProperty(e,r,{enumerable:t.enumerable,configurable:t.configurable,writable:t.writable,value:t.initializer?t.initializer.call(s):void 0})}function _applyDecoratedDescriptor(e,r,t,s,i){var o={};return Object.keys(s).forEach((function(e){o[e]=s[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=t.slice().reverse().reduce((function(t,s){return s(e,r,t)||t}),o),i&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(i):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,r,o),o=null),o}function _initializerWarningHelper(e,r){throw new Error("Decorating class property failed. Please ensure that proposal-class-properties is enabled and runs after the decorators transform.")}const debug=require("debug")("Ferdi:RequestsStore");let RequestStore=(_class=class extends _Store.default{constructor(...e){super(...e),_initializerDefineProperty(this,"userInfoRequest",_descriptor,this),_initializerDefineProperty(this,"servicesRequest",_descriptor2,this),_initializerDefineProperty(this,"showRequiredRequestsError",_descriptor3,this),_initializerDefineProperty(this,"localServerPort",_descriptor4,this),this.retries=0,this.retryDelay=(0,_ms.default)("2s"),this.actions.requests.retryRequiredRequests.listen(this._retryRequiredRequests.bind(this)),this.registerReactions([this._autoRetry.bind(this)])}setup(){this.userInfoRequest=this.stores.user.getUserInfoRequest,this.servicesRequest=this.stores.services.allServicesRequest,_electron.ipcRenderer.on("localServerPort",((e,r)=>{r.port&&(this.localServerPort=r.port)}))}get areRequiredRequestsSuccessful(){return!this.userInfoRequest.isError&&!this.servicesRequest.isError}get areRequiredRequestsLoading(){return this.userInfoRequest.isExecuting||this.servicesRequest.isExecuting}_retryRequiredRequests(){this.userInfoRequest.reload(),this.servicesRequest.reload()}_autoRetry(){const e=(this.retries<=10?this.retries:10)*this.retryDelay;!this.areRequiredRequestsSuccessful&&this.stores.user.isLoggedIn&&setTimeout((()=>{this.retries+=1,this._retryRequiredRequests(),4===this.retries&&(this.showRequiredRequestsError=!0),this._autoRetry(),debug(`Retry required requests delayed in ${e/1e3}s`)}),e)}},_descriptor=_applyDecoratedDescriptor(_class.prototype,"userInfoRequest",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_descriptor2=_applyDecoratedDescriptor(_class.prototype,"servicesRequest",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),_descriptor3=_applyDecoratedDescriptor(_class.prototype,"showRequiredRequestsError",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_descriptor4=_applyDecoratedDescriptor(_class.prototype,"localServerPort",[_mobx.observable],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45569}}),_applyDecoratedDescriptor(_class.prototype,"areRequiredRequestsSuccessful",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"areRequiredRequestsSuccessful"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"areRequiredRequestsLoading",[_mobx.computed],Object.getOwnPropertyDescriptor(_class.prototype,"areRequiredRequestsLoading"),_class.prototype),_applyDecoratedDescriptor(_class.prototype,"_retryRequiredRequests",[_mobx.action],Object.getOwnPropertyDescriptor(_class.prototype,"_retryRequiredRequests"),_class.prototype),_class);exports.default=RequestStore;