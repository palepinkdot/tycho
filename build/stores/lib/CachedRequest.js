"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _mobx=require("mobx"),_lodash=require("lodash"),_Request=_interopRequireDefault(require("./Request"));function _interopRequireDefault(t){return t&&t.__esModule?t:{default:t}}class CachedRequest extends _Request.default{constructor(...t){super(...t),this._apiCalls=[],this._isInvalidated=!0}execute(...t){if(this._isWaitingForResponse)return this;const i=this._findApiCall(t);return i&&i!==this._currentApiCall?(this._isInvalidated=!0,this._currentApiCall=i):i||(this._isInvalidated=!0,this._currentApiCall=this._addApiCall(t)),this._isInvalidated?(setTimeout((0,_mobx.action)((()=>{this.isExecuting=!0,i&&(this.result=i.result)})),0),this._promise=new Promise((i=>{this._api[this._method](...t).then((t=>(setTimeout((0,_mobx.action)((()=>{this.result=t,this._currentApiCall&&(this._currentApiCall.result=t),this.isExecuting=!1,this.isError=!1,this.wasExecuted=!0,this._isInvalidated=!1,this._isWaitingForResponse=!1,this._triggerHooks(),i(t)})),1),t))).catch((0,_mobx.action)((t=>{setTimeout((0,_mobx.action)((()=>{this.error=t,this.isExecuting=!1,this.isError=!0,this.wasExecuted=!0,this._isWaitingForResponse=!1,this._triggerHooks()})),1)})))})),this._isWaitingForResponse=!0,this):this}invalidate(t={immediately:!1}){return this._isInvalidated=!0,t.immediately&&this._currentApiCall?this.execute(...this._currentApiCall.args):this}patch(t){return new Promise((i=>{setTimeout((0,_mobx.action)((()=>{const s=t(this.result);void 0!==s&&(this.result=s),this._currentApiCall&&(this._currentApiCall.result=this.result),i(this)})),0)}))}removeCacheForCallWith(...t){(0,_lodash.remove)(this._apiCalls,(i=>(0,_lodash.isEqual)(i.args,t)))}_addApiCall(t){const i={args:t,result:null};return this._apiCalls.push(i),i}_findApiCall(t){return this._apiCalls.find((i=>(0,_lodash.isEqual)(i.args,t)))}}exports.default=CachedRequest;